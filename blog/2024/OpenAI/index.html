<!DOCTYPE html> <html lang="en"> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title> Reflection | Dong WANG </title> <meta name="author" content="Dong WANG"> <meta name="description" content="Reflection on Interview"> <meta name="keywords" content="jekyll, jekyll-theme, academic-website, portfolio-website"> <link rel="stylesheet" href="/assets/css/bootstrap.min.css?a4b3f509e79c54a512b890d73235ef04"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"> <link defer rel="stylesheet" href="/assets/css/academicons.min.css?f0b7046b84e425c55f3463ac249818f5"> <link defer rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons&amp;display=swap"> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-github.css?591dab5a4e56573bf4ef7fd332894c99" media="" id="highlight_theme_light"> <link rel="shortcut icon" href="/assets/img/favicon.png?0117f58ac8f10115352f400bac41bc98"> <link rel="stylesheet" href="/assets/css/main.css?d41d8cd98f00b204e9800998ecf8427e"> <link rel="canonical" href="https://aabbccdkg.github.io/blog/2024/OpenAI/"> <script src="/assets/js/theme.js?9a0c749ec5240d9cda97bc72359a72c0"></script> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-native.css?5847e5ed4a4568527aa6cfab446049ca" media="none" id="highlight_theme_dark"> <script>initTheme();</script> </head> <body class="fixed-top-nav "> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top" role="navigation"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="/"> <span class="font-weight-bold">Dong</span> WANG </a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/">About </a> </li> <li class="nav-item active"> <a class="nav-link" href="/blog/">Blog </a> </li> <li class="nav-item "> <a class="nav-link" href="/publications/">Publications </a> </li> <li class="nav-item "> <a class="nav-link" href="/projects/">Projects </a> </li> <li class="nav-item"> <button id="search-toggle" title="Search" onclick="openSearchModal()"> <span class="nav-link">ctrl k <i class="ti ti-search"></i></span> </button> </li> <li class="toggle-container"> <button id="light-toggle" title="Change theme"> <i class="ti ti-sun-moon" id="light-toggle-system"></i> <i class="ti ti-moon-filled" id="light-toggle-dark"></i> <i class="ti ti-sun-filled" id="light-toggle-light"></i> </button> </li> </ul> </div> </div> </nav> <progress id="progress" value="0"> <div class="progress-container"> <span class="progress-bar"></span> </div> </progress> </header> <div class="container mt-5" role="main"> <div class="post"> <header class="post-header"> <h1 class="post-title">Reflection</h1> <p class="post-meta"> Created in January 01, 2024 </p> <p class="post-tags"> <a href="/blog/2024"> <i class="fa-solid fa-calendar fa-sm"></i> 2024 </a>   ·   <a href="/blog/tag/leetcode"> <i class="fa-solid fa-hashtag fa-sm"></i> LeetCode</a>   ·   <a href="/blog/category/leetcode"> <i class="fa-solid fa-tag fa-sm"></i> LeetCode</a> </p> </header> <article class="post-content"> <div id="markdown-content"> <h1 id="key-value-store">Key-Value Store</h1> <p>序列化: 把内存中的数据结构转换成可以储存/传输的格式 序列化前: 是在内存中的复杂数据(不同类型，不同结构) 序列化后: 统一的字节流，所有数据都变成了0和1的序列 文件系统只能储存字节，不能直接储存Python对象或者Java对象 网络只能传输字节流，不能传输编程语言特定的对象 纯字节流无法区分边界: 0101010010001 解决办法: 长度前缀</p> <p>假设我们要存储 Key = “A”, Value = “BC”: 原始数据: key = “A” (1个字节), Value = “BC” (2个字节) 序列化后的字节流(4个字节, 1个字节是8位):</p> <ul> <li>key的长度前缀(len(‘A’).to_bytes(‘4’, big)): 00000001 00000000 00000000 00000000</li> <li>key的值(A.encode(‘utf-8’)): 01000001</li> <li>value的长度前缀(len(‘BC’).to_bytes(‘4’, big)): 00000010 00000000 00000000 00000000</li> <li>value的值(‘BC’.encode(‘utf-8’)): 01000010 01000011</li> </ul> <p>核心是hashmap到字节流的双向转换 这其中，长度前缀是固定长度，实际数据并不是固定长度</p> <p>Follow Up</p> <ul> <li>随便切: 按固定大小切割，不管数据边界</li> <li>记录信息: 用metadata记录切了几块</li> <li>先拼接: restore时按顺序拼接回完整字节流</li> <li>再解析: 对完整数据按原协议反序列化</li> </ul> <p>The core task is to implement an im-memory Key-Value (KV) store class that support persistence. This means the data held in memory (e.g., in hash map or dictionary) must be able to be saved to a storage “medium” and then loaded back</p> <h2 id="core-requirements-api">Core Requirements (API)</h2> <p>You need to implement a class with the following methods:</p> <ul> <li> <code class="language-plaintext highlighter-rouge">put(key, value)</code> or <code class="language-plaintext highlighter-rouge">set(key, value)</code>: Adds or updates a key-value pair in the in-memory store. Keys and values are typically string and/or integers.</li> <li> <code class="language-plaintext highlighter-rouge">get(key)</code>: Retrieves the value associated with a given key</li> <li> <code class="language-plaintext highlighter-rouge">shutdown()</code>: This method is responsible for serializing the entire in-memory KV store in to a byte array and writing it to the persistent medium using a provided helper function</li> <li> <code class="language-plaintext highlighter-rouge">restore()</code>: This method reads the byte array from the persistent medium and deserializes it tot reconstruct the KV store in memory</li> </ul> <h2 id="key-contraints--environment">Key Contraints &amp; Environment</h2> <ul> <li>provided helpers: you are given helper functions. You do need to handle file I/O (like opening files, naming them, or choosing paths). <ul> <li>Storage helpers: Functions like <code class="language-plaintext highlighter-rouge">save_blob(bytes)</code> and <code class="language-plaintext highlighter-rouge">get_blob()</code> are provided to hanlde the actual writing and reading of byte arrays to the persistent store</li> <li>Type Conversion helpers: Utility functions are provided to convert primitive types like strings and integers to and from byte arrays (e.g., <code class="language-plaintext highlighter-rouge">string_to_bytes</code>, <code class="language-plaintext highlighter-rouge">bytes_to_int</code>).</li> </ul> </li> <li>Major Restriction: You are explicitly forbidden from using standard, high-level serilization libraries like <code class="language-plaintext highlighter-rouge">JSON</code>, Python’s <code class="language-plaintext highlighter-rouge">pickle</code>, or Java’s built-in serialization. The main point of exercise is for you to design your own custom serialization protocol</li> </ul> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">string_to_bytes</span><span class="p">(</span><span class="n">value</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    convert string to bytes when store
    </span><span class="sh">"""</span>
    <span class="k">pass</span>

<span class="k">def</span> <span class="nf">bytes_to_string</span><span class="p">(</span><span class="n">value</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    convert bytes to string when get
    </span><span class="sh">"""</span>
    <span class="k">pass</span>

<span class="k">def</span> <span class="nf">save_blob</span><span class="p">(</span><span class="nb">bytes</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    save the bytes
    </span><span class="sh">"""</span>
    <span class="k">pass</span>

<span class="k">def</span> <span class="nf">get_blob</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    get the bytes
    </span><span class="sh">"""</span>
    <span class="k">pass</span>
<span class="k">class</span> <span class="nc">KVstore</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">dictionary</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">put</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">self</span><span class="p">.</span><span class="n">dictionary</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">selc</span><span class="p">.</span><span class="n">dictionary</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">shutdown</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="nb">bytes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">dictionary</span><span class="p">:</span>
            <span class="n">key_len</span> <span class="o">=</span> <span class="nf">len</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="n">serialized_key_len</span> <span class="o">=</span> <span class="nf">string_to_bytes</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="sh">'</span><span class="s">big</span><span class="sh">'</span><span class="p">)</span> 
            <span class="c1"># serialized_key_len = key_len.to_bytes(4, 'big')
</span>            <span class="c1"># integer.to_bytes(length, byteorder)是python整数对象内置的方法，用于将整数转换成字节
</span>            <span class="nb">bytes</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">serialized_key_len</span><span class="p">)</span>
            <span class="nb">bytes</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nf">string_to_bytes</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>
            <span class="c1"># bytes.append(key.encode())
</span>            <span class="c1"># string.key_encode()是python字符串对象内置方法，用于将字符串转换成字节
</span>            <span class="n">value_len</span> <span class="o">=</span> <span class="nf">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="n">serialized_value_len</span> <span class="o">=</span> <span class="nf">string_to_bytes</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="sh">'</span><span class="s">big</span><span class="sh">'</span><span class="p">)</span>
            <span class="nb">bytes</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">serialized_value_len</span><span class="p">)</span>
            <span class="nb">bytes</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nf">string_to_bytes</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
        <span class="nf">save_blob</span><span class="p">(</span><span class="nb">bytes</span><span class="p">)</span>
        <span class="c1"># 字符,字符串: save_blob(''.join(bytes)) '': 空字符串
</span>        <span class="c1"># 字节;字节串: svae_blob(b''.join(bytes)) b'': 空字节串
</span>        <span class="c1"># save_blob(b''.join(bytes))
</span>    <span class="k">def</span> <span class="nf">restore</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">bytesArryas</span> <span class="o">=</span> <span class="nf">get_blob</span><span class="p">()</span>
</code></pre></div></div> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Bucket</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">save_blob</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">load_blob</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
        <span class="k">pass</span>

<span class="k">class</span> <span class="nc">KVStore</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">store</span> <span class="o">=</span> <span class="p">{}</span> 
        <span class="n">self</span><span class="p">.</span><span class="n">bucket</span> <span class="o">=</span> <span class="nc">Bucket</span><span class="p">()</span>
        <span class="c1"># {} 创建字典(dictionary/map)
</span>        <span class="c1"># [] 创建列表(list)
</span>
    <span class="k">def</span> <span class="nf">put</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">store</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">store</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> 
        <span class="c1"># self.store[key]: 属于字典的操作, 如果key不存在会跑出KeyError异常
</span>        <span class="c1"># self.store.get(key): 也属于字典操作，如果key不存在就返回None, 更安全
</span>
    <span class="k">def</span> <span class="nf">shutdown</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">data</span> <span class="o">=</span> <span class="nf">bytearray</span><span class="p">()</span> <span class="c1"># 可变的字节数组，可以动态添加字节数据
</span>        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">store</span><span class="p">.</span><span class="nf">items</span><span class="p">():</span> 
            <span class="c1"># items()同时返回键值对，如果是for key in self.store只会遍历键
</span>            <span class="n">key_bytes</span> <span class="o">=</span> <span class="n">key</span><span class="p">.</span><span class="nf">encode</span><span class="p">(</span><span class="sh">'</span><span class="s">utf-8</span><span class="sh">'</span><span class="p">)</span>
            <span class="n">value_bytes</span> <span class="o">=</span> <span class="n">value</span><span class="p">.</span><span class="nf">encode</span><span class="p">(</span><span class="sh">'</span><span class="s">utf-8</span><span class="sh">'</span><span class="p">)</span>
            <span class="c1"># string.encode(): 把字符串转换成字节
</span>
            <span class="c1"># 先转换成字节后，再对字节长度序列化，而不是对string的长度序列化
</span>            <span class="c1"># 先转换成字节再计算长度，因为不同编码想啊统一字符串的字节长度可能不同
</span>            <span class="n">data</span><span class="p">.</span><span class="nf">extend</span><span class="p">(</span><span class="nf">len</span><span class="p">(</span><span class="n">key_bytes</span><span class="p">).</span><span class="nf">to_bytes</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="sh">'</span><span class="s">big</span><span class="sh">'</span><span class="p">))</span>
            <span class="n">data</span><span class="p">.</span><span class="nf">extend</span><span class="p">(</span><span class="n">key_bytes</span><span class="p">)</span>
            <span class="n">data</span><span class="p">.</span><span class="nf">extend</span><span class="p">(</span><span class="nf">len</span><span class="p">(</span><span class="n">value_bytes</span><span class="p">).</span><span class="nf">to_bytes</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="sh">'</span><span class="s">big</span><span class="sh">'</span><span class="p">))</span>
            <span class="n">data</span><span class="p">.</span><span class="nf">extend</span><span class="p">(</span><span class="n">value_bytes</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">bucket</span><span class="p">.</span><span class="nf">save_blob</span><span class="p">(</span><span class="sh">"</span><span class="s">data</span><span class="sh">"</span><span class="p">,</span> <span class="nf">bytes</span><span class="p">(</span><span class="n">data</span><span class="p">))</span> 
        <span class="c1"># bytes和bytearray都是字节串，bytearray可变，bytes不可变
</span>        
    
    <span class="k">def</span> <span class="nf">restore</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">bucket</span><span class="p">.</span><span class="nf">load_blob</span><span class="p">(</span><span class="sh">"</span><span class="s">data</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">store</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nf">len</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
            <span class="c1"># Read key
</span>            <span class="n">key_len</span> <span class="o">=</span> <span class="nb">int</span><span class="p">.</span><span class="nf">from_bytes</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">:</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">4</span><span class="p">],</span> <span class="sh">'</span><span class="s">big</span><span class="sh">'</span><span class="p">)</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">4</span>
            <span class="n">key</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span> <span class="o">+</span> <span class="n">key_len</span><span class="p">].</span><span class="nf">decode</span><span class="p">(</span><span class="sh">'</span><span class="s">utf-8</span><span class="sh">'</span><span class="p">)</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="n">key_len</span>

            <span class="c1"># Read value
</span>            <span class="n">value_len</span> <span class="o">=</span> <span class="nb">int</span><span class="p">.</span><span class="nf">from_bytes</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">:</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">4</span><span class="p">],</span> <span class="sh">'</span><span class="s">big</span><span class="sh">'</span><span class="p">)</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">4</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span> <span class="o">+</span> <span class="n">value_len</span><span class="p">].</span><span class="nf">decode</span><span class="p">(</span><span class="sh">'</span><span class="s">utf-8</span><span class="sh">'</span><span class="p">)</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="n">value_len</span>

            <span class="n">self</span><span class="p">.</span><span class="n">store</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
<span class="c1"># Follow-up: Multiple files when size &gt; 1KB
</span><span class="k">class</span> <span class="nc">KVstoreMultiFile</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">store</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">self</span><span class="p">.</span><span class="n">bucket</span> <span class="o">=</span> <span class="nc">Bucket</span><span class="p">()</span>
    
    <span class="k">def</span> <span class="nf">put</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">store</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
    
    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">store</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">shutdown</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">data</span> <span class="o">=</span> <span class="nf">bytearray</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">store</span><span class="p">.</span><span class="nf">items</span><span class="p">():</span>
            <span class="n">key_bytes</span> <span class="o">=</span> <span class="n">key</span><span class="p">.</span><span class="nf">encode</span><span class="p">(</span><span class="sh">'</span><span class="s">utf-8</span><span class="sh">'</span><span class="p">)</span>
            <span class="n">value_bytes</span> <span class="o">=</span> <span class="n">value</span><span class="p">.</span><span class="nf">encode</span><span class="p">(</span><span class="sh">'</span><span class="s">utf-8</span><span class="sh">'</span><span class="p">)</span>
            <span class="n">data</span><span class="p">.</span><span class="nf">extend</span><span class="p">(</span><span class="nf">len</span><span class="p">(</span><span class="n">key_bytes</span><span class="p">).</span><span class="nf">to_bytes</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="sh">'</span><span class="s">big</span><span class="sh">'</span><span class="p">))</span>
            <span class="c1"># string.encode(): encode是字符串到字节
</span>            <span class="c1"># integer.to_bytes(): to_bytes是整数到字节，固定长度，让反序列化时知道读几个字节。
</span>            <span class="n">data</span><span class="p">.</span><span class="nf">extend</span><span class="p">(</span><span class="n">key_bytes</span><span class="p">)</span>
            <span class="n">data</span><span class="p">.</span><span class="nf">extend</span><span class="p">(</span><span class="nf">len</span><span class="p">(</span><span class="n">value_bytes</span><span class="p">).</span><span class="nf">to_bytes</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="sh">'</span><span class="s">big</span><span class="sh">'</span><span class="p">))</span>
            <span class="n">data</span><span class="p">.</span><span class="nf">extend</span><span class="p">(</span><span class="n">value_bytes</span><span class="p">)</span>

        <span class="n">chunk_size</span> <span class="o">=</span> <span class="mi">1024</span> <span class="c1"># 1KB
</span>        <span class="n">chunks</span> <span class="o">=</span> <span class="p">[</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span> <span class="o">+</span> <span class="n">chunk_size</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nf">len</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="n">chunk_size</span><span class="p">)]</span>
        <span class="n">self</span><span class="p">.</span><span class="n">bucket</span><span class="p">.</span><span class="nf">save_blob</span><span class="p">(</span><span class="sh">"</span><span class="s">metadata</span><span class="sh">"</span><span class="p">,</span> <span class="nf">str</span><span class="p">(</span><span class="nf">len</span><span class="p">(</span><span class="n">chunks</span><span class="p">)).</span><span class="nf">encode</span><span class="p">())</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="nf">enumerate</span><span class="p">(</span><span class="n">chunks</span><span class="p">):</span>
            <span class="n">self</span><span class="p">.</span><span class="n">bucket</span><span class="p">.</span><span class="nf">save_blob</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">data_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="sh">"</span><span class="p">,</span> <span class="n">chunk</span><span class="p">)</span>
        
    <span class="k">def</span> <span class="nf">restore</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="c1"># Read metadata
</span>        <span class="n">num_chunks</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">bucket</span><span class="p">.</span><span class="nf">get_blob</span><span class="p">(</span><span class="sh">"</span><span class="s">metadata</span><span class="sh">"</span><span class="p">).</span><span class="nf">decode</span><span class="p">())</span>

        <span class="c1"># Read and Combine chunks
</span>        <span class="n">data</span> <span class="o">=</span> <span class="nf">bytearray</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="n">num_chunks</span><span class="p">):</span>
            <span class="n">data</span><span class="p">.</span><span class="nf">extend</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">bucket</span><span class="p">.</span><span class="nf">get_blob</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">data_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="sh">"</span><span class="p">))</span>
        
        <span class="c1"># Deserialize
</span>        <span class="n">self</span><span class="p">.</span><span class="n">store</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nf">len</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
            <span class="c1"># Read key
</span>            <span class="n">key_len</span> <span class="o">=</span> <span class="nb">int</span><span class="p">.</span><span class="nf">from_bytes</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">:</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">4</span><span class="p">],</span> <span class="sh">'</span><span class="s">big</span><span class="sh">'</span><span class="p">)</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">4</span>
            <span class="n">key</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span> <span class="o">+</span> <span class="n">key_len</span><span class="p">].</span><span class="nf">decode</span><span class="p">(</span><span class="sh">'</span><span class="s">utf-8</span><span class="sh">'</span><span class="p">)</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="n">key_len</span>

            <span class="c1"># Read value
</span>            <span class="n">value_len</span> <span class="o">=</span> <span class="nb">int</span><span class="p">.</span><span class="nf">from_bytes</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">:</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">4</span><span class="p">],</span> <span class="sh">'</span><span class="s">big</span><span class="sh">'</span><span class="p">)</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">4</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span> <span class="o">+</span> <span class="n">value_len</span><span class="p">].</span><span class="nf">decode</span><span class="p">(</span><span class="sh">'</span><span class="s">utf-8</span><span class="sh">'</span><span class="p">)</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="n">value_len</span>
        
            <span class="n">self</span><span class="p">.</span><span class="n">store</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
</code></pre></div></div> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="c1"># Exercise 1
</span><span class="k">class</span> <span class="nc">Bucket</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">save_blob</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">get_blob</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">pass</span>

<span class="k">class</span> <span class="nc">KVStore</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">store</span> <span class="o">=</span> <span class="p">{}</span> 
        <span class="n">self</span><span class="p">.</span><span class="n">bucket</span> <span class="o">=</span> <span class="nc">Bucket</span><span class="p">()</span>
    <span class="c1"># def __init__(self, store={}):
</span>    <span class="c1">#     self.store = store
</span>    <span class="c1"># 问题: 所有实例会共享同一个字典！
</span>    <span class="c1"># kv1 = KVStore()
</span>    <span class="c1"># kv2 = KVStore()
</span>    <span class="c1"># kv1.put("key", "value")
</span>    <span class="c1"># print(kv2.get("key"))  # 意外地输出"value"！因为默认参数旨在函数定义的时候创建一次，此时store = {}是默认参数，所以永远不要用可变对象作为默认参数
</span>
    <span class="k">def</span> <span class="nf">put</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">self</span><span class="p">.</span><span class="n">store</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
    
    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">store</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">shutdown</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">data</span> <span class="o">=</span> <span class="nf">bytes</span><span class="p">()</span> <span class="c1"># 可变字节流 #是bytearray()不是bytes()
</span>        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">store</span><span class="p">.</span><span class="nf">items</span><span class="p">():</span>
            <span class="n">key_bytes</span> <span class="o">=</span> <span class="n">key</span><span class="p">.</span><span class="nf">encode</span><span class="p">(</span><span class="sh">'</span><span class="s">utf-8</span><span class="sh">'</span><span class="p">)</span>
            <span class="n">value_bytes</span> <span class="o">=</span> <span class="n">value</span><span class="p">.</span><span class="nf">encode</span><span class="p">(</span><span class="sh">'</span><span class="s">utf-8</span><span class="sh">'</span><span class="p">)</span>

            <span class="n">key_bytes_len</span> <span class="o">=</span> <span class="nf">len</span><span class="p">(</span><span class="n">key_bytes</span><span class="p">).</span><span class="nf">to_bytes</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">big</span><span class="p">)</span> <span class="c1"># 是(4, 'big')不是(4, big)
</span>            <span class="n">value_bytes_len</span> <span class="o">=</span> <span class="nf">len</span><span class="p">(</span><span class="n">value_bytes</span><span class="p">).</span><span class="nf">to_bytes</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">big</span><span class="p">)</span>
            <span class="n">data</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">key_bytes_len</span><span class="p">)</span> <span class="c1">#用extend不是append
</span>            <span class="n">data</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">key_bytes</span><span class="p">)</span>
            <span class="n">data</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">value_bytes_len</span><span class="p">)</span>
            <span class="n">data</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">value_bytes</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">bucket</span><span class="p">.</span><span class="nf">save_blob</span><span class="p">(</span><span class="sa">b</span><span class="sh">''</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">data</span><span class="p">))</span> <span class="c1">#转换成bytes: self.bucket.save_blob(bytes(data))
</span>
    <span class="k">def</span> <span class="nf">restore</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">bucket</span><span class="p">.</span><span class="nf">get_blob</span><span class="p">()</span>
        <span class="c1"># 清空现有数据: self.store = {}
</span>        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nf">len</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
            <span class="n">key_len</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span> <span class="o">+</span> <span class="mi">4</span><span class="p">].</span><span class="nf">from_bytes</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">big</span><span class="p">)</span> 
            <span class="c1"># 是int.from_bytes(data[i:i+4], 'big')
</span>            <span class="c1"># i 后面是会 + 4的，不用担心怎么实现每次跳4的遍历
</span>            <span class="n">i</span> <span class="o">+=</span> <span class="mi">4</span>
            <span class="n">key</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span> <span class="o">+</span> <span class="n">key_len</span><span class="p">].</span><span class="nf">decode</span><span class="p">(</span><span class="sh">'</span><span class="s">utf-8</span><span class="sh">'</span><span class="p">)</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="n">key_len</span>

            <span class="n">value_len</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">4</span><span class="p">].</span><span class="nf">from_bytes</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">big</span><span class="p">)</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">4</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span> <span class="o">+</span> <span class="n">value_len</span><span class="p">].</span><span class="nf">decode</span><span class="p">(</span><span class="sh">'</span><span class="s">utf-8</span><span class="sh">'</span><span class="p">)</span>
            <span class="c1">#移动指针: i += value_len
</span>
            <span class="n">self</span><span class="p">.</span><span class="n">store</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

<span class="c1"># Follow Up:
</span><span class="k">class</span> <span class="nc">Bucket</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">save_blob</span><span class="p">(</span><span class="nb">bytes</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">get_blob</span><span class="p">(</span><span class="nb">bytes</span><span class="p">):</span>
        <span class="k">pass</span>

<span class="k">class</span> <span class="nc">KVStore</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">store</span> <span class="o">=</span> <span class="p">{}</span> 
        <span class="n">self</span><span class="p">.</span><span class="n">bucket</span> <span class="o">=</span> <span class="nc">Bucket</span><span class="p">()</span>
    <span class="c1"># def __init__(self, store={}):
</span>    <span class="c1">#     self.store = store
</span>    <span class="c1"># 问题: 所有实例会共享同一个字典！
</span>    <span class="c1"># kv1 = KVStore()
</span>    <span class="c1"># kv2 = KVStore()
</span>    <span class="c1"># kv1.put("key", "value")
</span>    <span class="c1"># print(kv2.get("key"))  # 意外地输出"value"！因为默认参数旨在函数定义的时候创建一次，此时store = {}是默认参数，所以永远不要用可变对象作为默认参数
</span>
    <span class="k">def</span> <span class="nf">put</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">self</span><span class="p">.</span><span class="n">store</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
    
    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">store</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">shutdown</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">data</span> <span class="o">=</span> <span class="nf">bytes</span><span class="p">()</span> <span class="c1"># 可变字节流
</span>        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">store</span><span class="p">.</span><span class="nf">items</span><span class="p">():</span>
            <span class="n">key_bytes</span> <span class="o">=</span> <span class="n">key</span><span class="p">.</span><span class="nf">encode</span><span class="p">(</span><span class="sh">'</span><span class="s">utf-8</span><span class="sh">'</span><span class="p">)</span>
            <span class="n">value_bytes</span> <span class="o">=</span> <span class="n">vaule</span><span class="p">.</span><span class="nf">encode</span><span class="p">(</span><span class="sh">'</span><span class="s">utf-8</span><span class="sh">'</span><span class="p">)</span>

            <span class="n">key_bytes_len</span> <span class="o">=</span> <span class="nf">len</span><span class="p">(</span><span class="n">key_bytes</span><span class="p">).</span><span class="nf">to_bytes</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">big</span><span class="p">)</span>
            <span class="n">value_bytes_len</span> <span class="o">=</span> <span class="nf">len</span><span class="p">(</span><span class="n">value_bytes</span><span class="p">).</span><span class="nf">to_bytes</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">big</span><span class="p">)</span>
            <span class="n">data</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">key_bytes_len</span><span class="p">)</span>
            <span class="n">data</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">key_bytes</span><span class="p">)</span>
            <span class="n">data</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">value_bytes_len</span><span class="p">)</span>
            <span class="n">data</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">value_bytes</span><span class="p">)</span>
        <span class="n">chunk_size</span> <span class="o">=</span> <span class="mi">1024</span>
        <span class="n">chunks</span> <span class="o">=</span> <span class="p">[</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span> <span class="o">+</span> <span class="n">chunk_size</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nf">len</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="n">chunk_size</span><span class="p">)]</span>

        <span class="n">self</span><span class="p">.</span><span class="n">bucket</span><span class="p">.</span><span class="nf">save_blob</span><span class="p">(</span><span class="sh">"</span><span class="s">metadata</span><span class="sh">"</span><span class="p">,</span> <span class="nf">str</span><span class="p">(</span><span class="nf">len</span><span class="p">(</span><span class="n">chunks</span><span class="p">)).</span><span class="nf">encode</span><span class="p">(</span><span class="sh">'</span><span class="s">utf-8</span><span class="sh">'</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="nf">len</span><span class="p">(</span><span class="n">chunks</span><span class="p">)):</span>
            <span class="n">self</span><span class="p">.</span><span class="n">bucket</span><span class="p">.</span><span class="nf">save_blob</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">data_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="sh">"</span><span class="p">,</span> <span class="n">chunks</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">restore</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">num_chunks</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">bucket</span><span class="p">.</span><span class="nf">get_blob</span><span class="p">(</span><span class="sh">"</span><span class="s">metadata</span><span class="sh">"</span><span class="p">).</span><span class="nf">decode</span><span class="p">(</span><span class="sh">'</span><span class="s">utf-8</span><span class="sh">'</span><span class="p">))</span>

        <span class="n">data</span> <span class="o">=</span> <span class="nf">bytearray</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="n">num_chunks</span><span class="p">):</span>
            <span class="n">data</span><span class="p">.</span><span class="nf">extend</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">bucket</span><span class="p">.</span><span class="nf">get_blob</span><span class="p">(</span><span class="sa">f</span><span class="sh">'</span><span class="s">data_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="sh">'</span><span class="p">))</span>
        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">self</span><span class="p">.</span><span class="n">store</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nf">len</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
            <span class="n">key_len</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span> <span class="o">+</span> <span class="mi">4</span><span class="p">].</span><span class="nf">from_bytes</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">big</span><span class="p">)</span>
            <span class="c1"># i 后面是会 + 4的，不用担心怎么实现每次跳4的遍历
</span>            <span class="n">i</span> <span class="o">+=</span> <span class="mi">4</span>
            <span class="n">key</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span> <span class="o">+</span> <span class="n">key_len</span><span class="p">].</span><span class="nf">decode</span><span class="p">(</span><span class="sh">'</span><span class="s">utf-8</span><span class="sh">'</span><span class="p">)</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="n">key_len</span>

            <span class="n">value_len</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">4</span><span class="p">].</span><span class="nf">from_bytes</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">big</span><span class="p">)</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">4</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span> <span class="o">+</span> <span class="n">value_len</span><span class="p">].</span><span class="nf">decode</span><span class="p">(</span><span class="sh">'</span><span class="s">utf-8</span><span class="sh">'</span><span class="p">)</span>

            <span class="n">self</span><span class="p">.</span><span class="n">store</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

</code></pre></div></div> <h1 id="gpu-credit-scheduling-system">GPU Credit Scheduling System</h1> <p>You need to implement a class with the following three methods:</p> <ul> <li> <code class="language-plaintext highlighter-rouge">add_credit(grant_id: str, amount: int, timestamp: int, expire: int)</code>: This function records that a certain <code class="language-plaintext highlighter-rouge">amount</code> of credit, identified by <code class="language-plaintext highlighter-rouge">grant_id</code>, becomes available at <code class="language-plaintext highlighter-rouge">timestamp</code>. The expire value is a duration, meaning the credit is valid for the time interval <code class="language-plaintext highlighter-rouge">[timestamp, timestamp + expire]</code> </li> <li> <code class="language-plaintext highlighter-rouge">charge(amount: int, timestamp: int)</code>: This function records a usage of a certain <code class="language-plaintext highlighter-rouge">amount</code> of credit at a specific <code class="language-plaintext highlighter-rouge">timestamp</code> </li> <li> <code class="language-plaintext highlighter-rouge">get_balance(timestamp: int) -&gt; int</code>: This function calculates and returns the total available credit at a given <code class="language-plaintext highlighter-rouge">timestamp</code> </li> </ul> <p><code class="language-plaintext highlighter-rouge">grant_id</code>: 授权ID, 每个信用额度的唯一标识符，区分不同批次的信用额度 <code class="language-plaintext highlighter-rouge">timestamp</code>: 时间戳, 记录事件发生的具体时间点</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">heapq</span>
<span class="k">class</span> <span class="nc">GPUSolution</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">events</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># 存储所有事件
</span>
    <span class="k">def</span> <span class="nf">add_credit</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">grant_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">amount</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">expire</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
        <span class="c1"># 只记录事件，不计算
</span>        <span class="n">self</span><span class="p">.</span><span class="n">events</span><span class="p">.</span><span class="nf">append</span><span class="p">((</span><span class="sh">'</span><span class="s">add</span><span class="sh">'</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">,</span> <span class="n">amount</span><span class="p">,</span> <span class="n">timestamp</span> <span class="o">+</span> <span class="n">expire</span><span class="p">,</span> <span class="n">grant_id</span><span class="p">))</span>
    
    <span class="k">def</span> <span class="nf">charge</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">amount</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
        <span class="c1"># 只记录事件，不计算
</span>        <span class="n">self</span><span class="p">.</span><span class="n">events</span><span class="p">.</span><span class="nf">append</span><span class="p">((</span><span class="sh">'</span><span class="s">charge</span><span class="sh">'</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">,</span> <span class="n">amount</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">get_balance</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span> 
        <span class="c1"># 在timestamp这个时间点的余额: 计算timestamp时间点及之前发生的事件，返回timestamp时刻的信用余额
</span>        <span class="c1"># 筛选并排序事件
</span>        <span class="n">valid_events</span> <span class="o">=</span> <span class="p">[</span><span class="n">e</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">events</span> <span class="k">if</span> <span class="n">e</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">timestamp</span><span class="p">]</span>
        <span class="n">valid_events</span><span class="p">.</span><span class="nf">sort</span><span class="p">(</span><span class="n">key</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="c1"># 按时间戳排序
</span>        <span class="c1"># 从大到小排序: valid_events.sort(key = lambda x: x[1], reverse = True)
</span>
        <span class="c1"># 最小堆(过期时间， 剩余金额，grant_id)
</span>        <span class="n">active_grants</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># 按时间顺序处理事件
</span>        <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">valid_events</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">event</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sh">'</span><span class="s">add</span><span class="sh">'</span><span class="p">:</span>
                <span class="n">_</span><span class="p">,</span> <span class="n">ts</span><span class="p">,</span> <span class="n">amount</span><span class="p">,</span> <span class="n">expire_ts</span><span class="p">,</span> <span class="n">grant_id</span> <span class="o">=</span> <span class="n">event</span>
                <span class="k">if</span> <span class="n">expire_ts</span> <span class="o">&gt;</span> <span class="n">timestamp</span><span class="p">:</span> <span class="c1"># 还没过期
</span>                    <span class="n">heapq</span><span class="p">.</span><span class="nf">heappush</span><span class="p">(</span><span class="n">active_grants</span><span class="p">,</span> <span class="p">(</span><span class="n">expire_ts</span><span class="p">,</span> <span class="n">amount</span><span class="p">,</span> <span class="n">grant_id</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">event</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sh">'</span><span class="s">charge</span><span class="sh">'</span><span class="p">:</span>
                <span class="n">_</span><span class="p">,</span> <span class="n">ts</span><span class="p">,</span> <span class="n">charge_amount</span> <span class="o">=</span> <span class="n">event</span>
                <span class="n">remaining_charge</span> <span class="o">=</span> <span class="n">charge_amount</span>
                
                <span class="c1"># 优先消耗最早过期的credit
</span>                <span class="n">temp_grants</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">while</span> <span class="n">active_grants</span> <span class="ow">and</span> <span class="n">remaining_charge</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">expire_ts</span><span class="p">,</span> <span class="n">available</span><span class="p">,</span> <span class="n">grant_id</span> <span class="o">=</span> <span class="n">heapq</span><span class="p">.</span><span class="nf">heappop</span><span class="p">(</span><span class="n">active_grants</span><span class="p">)</span> <span class="c1"># 自动跳出第一个位置数字最小的tuple
</span>
                    <span class="k">if</span> <span class="n">available</span> <span class="o">&lt;=</span> <span class="n">remaining_charge</span><span class="p">:</span>
                        <span class="n">remaining_charge</span> <span class="o">-=</span> <span class="n">available</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># 部分消耗
</span>                        <span class="n">temp_grants</span><span class="p">.</span><span class="nf">append</span><span class="p">((</span><span class="n">expire_ts</span><span class="p">,</span> <span class="n">available</span> <span class="o">-</span> <span class="n">remaining_charge</span><span class="p">,</span> <span class="n">grant_id</span><span class="p">))</span>
                        <span class="n">remaining_charge</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="c1"># 把剩余的grant放回去
</span>                <span class="k">for</span> <span class="n">grant</span> <span class="ow">in</span> <span class="n">temp_grants</span><span class="p">:</span>
                    <span class="n">heapq</span><span class="p">.</span><span class="nf">heappush</span><span class="p">(</span><span class="n">active_grants</span><span class="p">,</span> <span class="n">grant</span><span class="p">)</span>
        <span class="n">total</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">expire_ts</span><span class="p">,</span> <span class="n">amount</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">active_grants</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">expire_ts</span> <span class="o">&gt;</span> <span class="n">timestamp</span><span class="p">:</span>
                <span class="n">total</span> <span class="o">+=</span> <span class="n">amount</span>
        <span class="k">return</span> <span class="n">total</span>
</code></pre></div></div> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># exercise
</span><span class="kn">import</span> <span class="n">heapq</span>
<span class="k">class</span> <span class="nc">GPUSolution</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">events</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">def</span> <span class="nf">add_credit</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">grant_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">amount</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">expire</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">events</span><span class="p">.</span><span class="nf">append</span><span class="p">((</span><span class="sh">'</span><span class="s">add</span><span class="sh">'</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">,</span> <span class="n">amount</span><span class="p">,</span> <span class="n">timestamp</span> <span class="o">+</span> <span class="n">expire</span><span class="p">,</span> <span class="n">grant_id</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">charge</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">amount</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">events</span><span class="p">.</span><span class="nf">append</span><span class="p">((</span><span class="sh">'</span><span class="s">charge</span><span class="sh">'</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">,</span> <span class="n">amount</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">get_balance</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="n">valid_events</span> <span class="o">=</span> <span class="p">[</span><span class="n">e</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">events</span> <span class="k">if</span> <span class="n">e</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">timestamp</span><span class="p">]</span>
        <span class="n">valid_events</span><span class="p">.</span><span class="nf">sort</span><span class="p">(</span><span class="n">key</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="c1"># valid_events是记录已经发生的事件
</span>        <span class="c1"># activate_grants是已经发生的事件中未过期的事件
</span>        <span class="n">activate_grants</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">valid_events</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">event</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sh">'</span><span class="s">add</span><span class="sh">'</span><span class="p">:</span>
                <span class="n">_</span><span class="p">,</span> <span class="n">ts</span><span class="p">,</span> <span class="n">amt</span><span class="p">,</span> <span class="n">exp_ts</span><span class="p">,</span> <span class="n">grant_id</span> <span class="o">=</span> <span class="n">event</span>
                <span class="c1"># 
</span>                <span class="k">if</span> <span class="n">exp_ts</span> <span class="o">&gt;</span> <span class="n">timestamp</span><span class="p">:</span>
                    <span class="c1"># 已经发生的事件中未过期的事件
</span>                    <span class="c1"># 如果是for event in events，就有可能是没有发生的事件中未过期的
</span>                    <span class="n">heapq</span><span class="p">.</span><span class="nf">heappush</span><span class="p">(</span><span class="n">activate_grants</span><span class="p">,</span> <span class="p">(</span><span class="n">exp_ts</span><span class="p">,</span> <span class="n">amt</span><span class="p">,</span> <span class="n">grant_id</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">event</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sh">'</span><span class="s">charge</span><span class="sh">'</span><span class="p">:</span>
                <span class="n">_</span><span class="p">,</span> <span class="n">ts</span><span class="p">,</span> <span class="n">charge_amount</span> <span class="o">=</span> <span class="n">event</span>
                <span class="n">remaining_charge</span> <span class="o">=</span> <span class="n">charge_amount</span>
                <span class="k">while</span> <span class="n">activate_grants</span> <span class="ow">and</span> <span class="n">remaining_charge</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">exp_ts</span><span class="p">,</span> <span class="n">available</span><span class="p">,</span> <span class="n">grant_id</span> <span class="o">=</span> <span class="n">heapq</span><span class="p">.</span><span class="nf">heappop</span><span class="p">(</span><span class="n">activate_grants</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">available</span> <span class="o">&lt;</span> <span class="n">remaining_charge</span><span class="p">:</span>
                        <span class="n">remaining_charge</span> <span class="o">-=</span> <span class="n">available</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">heapq</span><span class="p">.</span><span class="nf">heappush</span><span class="p">(</span><span class="n">activate_grants</span><span class="p">,</span> <span class="p">(</span><span class="n">exp_ts</span><span class="p">,</span> <span class="n">available</span> <span class="o">-</span> <span class="n">remaining_charge</span><span class="p">,</span> <span class="n">grant_id</span><span class="p">))</span>
                        <span class="n">remaining_charge</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">total</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">activate_grants</span><span class="p">:</span>
            <span class="n">total</span> <span class="o">+=</span> <span class="n">e</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">total</span>
</code></pre></div></div> <h1 id="machine-tree">Machine Tree</h1> <p>分布式算法计算树的节点数量 传统算法: 所有节点在同一台电脑的内存中，可以直接用root.children[0].children[1].count()来计算 分布式算法: 节点在不同电脑中，需要定义通信函数sendAsyncMessage()来获取子节点数量</p> <p>同步: A先等B回复，再等C回复(串行) 异步: A同时等B和C回复(并行，更快)</p> <p>You are given a system of machines organized in a tree structure. Each machine is a node in the tree, has a unique <code class="language-plaintext highlighter-rouge">nodeId</code>, and knows about its children and its parent (except for the root node)</p> <p>You need to implement the logic for two main functionalities:</p> <ul> <li> <code class="language-plaintext highlighter-rouge">count</code>: Count the total number of machines (nodes) in the tree.</li> <li> <code class="language-plaintext highlighter-rouge">topology</code>: Generate a string representation of the entire tree structure (e.g., using nested maps or a similar format)</li> </ul> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">MachineTree</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">nodeId</span><span class="p">,</span> <span class="n">children</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">parent</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">nodeId</span> <span class="o">=</span> <span class="n">nodeId</span>
        <span class="n">self</span><span class="p">.</span><span class="n">children</span> <span class="o">=</span> <span class="n">children</span> <span class="ow">or</span> <span class="p">[]</span>
        <span class="n">self</span><span class="p">.</span><span class="n">parent</span> <span class="o">=</span> <span class="n">parent</span>
        <span class="n">self</span><span class="p">.</span><span class="n">pending</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">self</span><span class="p">.</span><span class="n">results</span> <span class="o">=</span> <span class="p">{}</span>
    
    <span class="k">def</span> <span class="nf">receiveMessage</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
        <span class="n">msg_type</span> <span class="o">=</span> <span class="n">message</span><span class="p">[</span><span class="sh">'</span><span class="s">type</span><span class="sh">'</span><span class="p">]</span>
        <span class="n">request_id</span> <span class="o">=</span> <span class="n">message</span><span class="p">[</span><span class="sh">'</span><span class="s">request_id</span><span class="sh">'</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">msg_type</span> <span class="ow">in</span> <span class="p">[</span><span class="sh">'</span><span class="s">count_request</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">topology_request</span><span class="sh">'</span><span class="p">]:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">self</span><span class="p">.</span><span class="n">children</span><span class="p">:</span>
                <span class="c1"># leaf node
</span>                <span class="n">result</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">msg_type</span> <span class="o">==</span> <span class="sh">'</span><span class="s">count_request</span><span class="sh">'</span> <span class="k">else</span> <span class="p">{</span><span class="n">self</span><span class="p">.</span><span class="n">nodeId</span><span class="p">:</span> <span class="p">{}}</span>
                <span class="n">self</span><span class="p">.</span><span class="nf">_send_response</span><span class="p">(</span><span class="n">message</span><span class="p">[</span><span class="sh">'</span><span class="s">from</span><span class="sh">'</span><span class="p">],</span> <span class="n">request_id</span><span class="p">,</span> <span class="n">msg_type</span><span class="p">.</span><span class="nf">replace</span><span class="p">(</span><span class="sh">'</span><span class="s">request</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">response</span><span class="sh">'</span><span class="p">),</span> <span class="n">result</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Forward to children
</span>                <span class="n">self</span><span class="p">.</span><span class="n">pending</span><span class="p">[</span><span class="n">request_id</span><span class="p">]</span> <span class="o">=</span> <span class="nf">len</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">children</span><span class="p">)</span>
                <span class="n">self</span><span class="p">.</span><span class="n">results</span><span class="p">[</span><span class="n">request_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">children</span><span class="p">:</span>
                    <span class="nf">sendAsyncMessage</span><span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="p">{</span>
                        <span class="sh">'</span><span class="s">type</span><span class="sh">'</span><span class="p">:</span> <span class="n">msg_type</span><span class="p">,</span>
                        <span class="sh">'</span><span class="s">request_id</span><span class="sh">'</span><span class="p">:</span> <span class="n">request_id</span><span class="p">,</span>
                        <span class="sh">'</span><span class="s">from</span><span class="sh">'</span><span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">nodeId</span>
                    <span class="p">})</span>
        <span class="k">elif</span> <span class="n">msg_type</span> <span class="ow">in</span> <span class="p">[</span><span class="sh">'</span><span class="s">count_response</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">topology_response</span><span class="sh">'</span><span class="p">]:</span>
            <span class="c1"># Store child result
</span>            <span class="n">self</span><span class="p">.</span><span class="n">results</span><span class="p">[</span><span class="n">request_id</span><span class="p">][</span><span class="n">message</span><span class="p">[</span><span class="sh">'</span><span class="s">from</span><span class="sh">'</span><span class="p">]]</span> <span class="o">=</span> <span class="n">message</span><span class="p">[</span><span class="sh">'</span><span class="s">result</span><span class="sh">'</span><span class="p">]</span>
            <span class="n">self</span><span class="p">.</span><span class="n">pending</span><span class="p">[</span><span class="n">request_id</span><span class="p">]</span> <span class="o">-=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">pending</span><span class="p">[</span><span class="n">request_id</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># All children responded - aggregate
</span>                <span class="k">if</span> <span class="n">msg_type</span> <span class="o">==</span> <span class="sh">'</span><span class="s">count_response</span><span class="sh">'</span><span class="p">:</span>
                    <span class="n">total</span> <span class="o">=</span> <span class="nf">sum</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">results</span><span class="p">[</span><span class="n">request_id</span><span class="p">].</span><span class="nf">values</span><span class="p">())</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>  <span class="c1"># topology_response
</span>                    <span class="n">total</span> <span class="o">=</span> <span class="p">{</span><span class="n">self</span><span class="p">.</span><span class="n">nodeId</span><span class="p">:</span> <span class="p">{}}</span>
                    <span class="k">for</span> <span class="n">child_topo</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">results</span><span class="p">[</span><span class="n">request_id</span><span class="p">].</span><span class="nf">values</span><span class="p">():</span>
                        <span class="n">total</span><span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">nodeId</span><span class="p">].</span><span class="nf">update</span><span class="p">(</span><span class="n">child_topo</span><span class="p">)</span>
                
                <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">parent</span><span class="p">:</span>
                    <span class="n">self</span><span class="p">.</span><span class="nf">_send_response</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">parent</span><span class="p">,</span> <span class="n">request_id</span><span class="p">,</span> <span class="n">msg_type</span><span class="p">,</span> <span class="n">total</span><span class="p">)</span>
                
                <span class="c1"># Cleanup
</span>                <span class="k">del</span> <span class="n">self</span><span class="p">.</span><span class="n">pending</span><span class="p">[</span><span class="n">request_id</span><span class="p">]</span>
                <span class="k">del</span> <span class="n">self</span><span class="p">.</span><span class="n">results</span><span class="p">[</span><span class="n">request_id</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_send_response</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">to_node</span><span class="p">,</span> <span class="n">request_id</span><span class="p">,</span> <span class="n">msg_type</span><span class="p">,</span> <span class="n">result</span><span class="p">):</span>
        <span class="nf">sendAsyncMessage</span><span class="p">(</span><span class="n">to_node</span><span class="p">,</span> <span class="p">{</span>
            <span class="sh">'</span><span class="s">type</span><span class="sh">'</span><span class="p">:</span> <span class="n">msg_type</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">request_id</span><span class="sh">'</span><span class="p">:</span> <span class="n">request_id</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">from</span><span class="sh">'</span><span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">nodeId</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">result</span><span class="sh">'</span><span class="p">:</span> <span class="n">result</span>
        <span class="p">})</span>
</code></pre></div></div> <h1 id="bq面试">BQ面试</h1> <h2 id="最高优先级问题">最高优先级问题</h2> <ol> <li>Failed project + 从失败中学到什么 - 几乎每轮都问</li> <li>Make impact out of your scope - 高频问题，体现leadership</li> <li>最大的achievement - 标准问题</li> <li>如何解决conflict - 经典BQ问题</li> <li>为什么选择OpenAI + 对AI的看法 - 公司特定问题</li> </ol> <h2 id="中等优先级问题">中等优先级问题</h2> <ol> <li>Lead的项目 + 遇到的挑战 - 结合deep dive准备</li> <li>个人项目经历 - 展示主动性</li> <li>如何handle stress和move fast - OpenAI节奏很快</li> </ol> <h2 id="准备策略">准备策略</h2> <p>回答格式： • 准备30秒精炼版本 + 可展开的详细版本 • 使用STAR方法，强调可量化结果 • 重点突出execution和leadership能力</p> <p>关键特质展示： • 快速迭代和执行能力 • 在高压环境下的表现 • 跨团队协作能力 • 从失败中快速学习的能力</p> <p>注意事项： • 面试官可能时间紧张，要准备被打断 • 强调business value而非纯技术细节 • 体现对AI safety的思考</p> <h2 id="q1-tell-me-about-a-failed-project-and-what-you-learned-from-it">Q1: Tell me about a failed project and what you learned from it</h2> <h3 id="逻辑框架--logic-framework">逻辑框架 | Logic Framework</h3> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>设计系统 → 过度复杂 → 性能问题 → 重新简化 → 效果改善 → 经验教训
Design system → Over-engineer → Performance issue → Simplify → Better results → Lesson learned
</code></pre></div></div> <h3 id="概念组合--concept-combinations">概念组合 | Concept Combinations</h3> <table> <tbody> <tr> <td>**系统类型</td> <td>System Type:**</td> </tr> <tr> <td>- 实时交易分析系统</td> <td>real-time transaction analytics system</td> </tr> <tr> <td>- 欺诈检测平台</td> <td>fraud detection platform</td> </tr> </tbody> </table> <table> <tbody> <tr> <td>**问题描述</td> <td>Problem Description:**</td> </tr> <tr> <td>- 架构过于复杂</td> <td>overly complex architecture</td> </tr> <tr> <td>- 多层缓存</td> <td>multi-layered caching</td> </tr> <tr> <td>- 复杂数据处理管道</td> <td>complex data processing pipelines</td> </tr> <tr> <td>- 处理所有边界情况</td> <td>handle all edge cases</td> </tr> </tbody> </table> <table> <tbody> <tr> <td>**解决方案</td> <td>Solution:**</td> </tr> <tr> <td>- 简化架构</td> <td>simplified architecture</td> </tr> <tr> <td>- WebSocket连接</td> <td>WebSocket connection</td> </tr> <tr> <td>- 优化数据流</td> <td>optimized data flows</td> </tr> <tr> <td>- 流线型设计</td> <td>streamlined design</td> </tr> </tbody> </table> <table> <tbody> <tr> <td>**结果指标</td> <td>Results:**</td> </tr> <tr> <td>- 响应时间</td> <td>response time</td> </tr> <tr> <td>- 15分钟→30秒</td> <td>15 minutes → 30 seconds</td> </tr> <tr> <td>- 欺诈拦截率提升40%</td> <td>fraud interception increased by 40%</td> </tr> </tbody> </table> <table> <tbody> <tr> <td>**学习收获</td> <td>Learning:**</td> </tr> <tr> <td>- 简单有效</td> <td>simple and effective</td> </tr> <tr> <td>- 业务需求导向</td> <td>business requirement driven</td> </tr> <tr> <td>- 核心功能优先</td> <td>core functionality first</td> </tr> </tbody> </table> <p>30秒STAR回答： “在Bank of China实习时，我设计的实时交易分析系统最初架构过于复杂，导致响应时间达到15分钟，无法满足欺诈检测需求。我重新简化架构，采用 WebSocket和优化数据流，最终将响应时间降到30秒，欺诈拦截率提升40%。学到了简单有效比复杂设计更重要。”</p> <p>Follow-up: What specifically made the architecture too complex? “我设计了多层缓存和复杂的数据处理管道，想要处理所有edge cases。但实际上业务只需要快速的异常检测，不需要那么多层次。”</p> <p>Follow-up: How did you realize you needed to change approach? “当我看到15分钟延迟时，我主动找业务团队了解真实需求，发现他们只需要秒级响应的核心功能。”</p> <p>30-second STAR response: “During my internship at Bank of China, I initially designed an overly complex architecture for a real-time transaction analytics system, resulting in 15-minute response times that couldn’t meet fraud detection requirements. I redesigned the architecture with a simplified approach using WebSocket and optimized data flows, ultimately reducing response time to 30 seconds and increasing fraud interception by 40%. I learned that simple and effective solutions are better than complex designs.”</p> <p>Follow-up: What specifically made the architecture too complex? “I designed multi-layered caching and complex data processing pipelines, trying to handle all edge cases. But the business actually only needed fast anomaly detection, not all those layers.”</p> <p>Follow-up: How did you realize you needed to change approach? “When I saw the 15-minute delay, I proactively reached out to the business team to understand the real requirements and found they only needed core functionality with second-level response.</p> <h2 id="q2-whats-your-biggest-achievement">Q2: What’s your biggest achievement?</h2> <h3 id="逻辑框架--logic-framework-1">逻辑框架 | Logic Framework</h3> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>接受挑战 → 识别瓶颈 → 创新解决 → 显著提升 → 用户受益
Accept challenge → Identify bottleneck → Innovative solution → Significant improvement → User benefit
</code></pre></div></div> <h3 id="概念组合--concept-combinations-1">概念组合 | Concept Combinations</h3> <table> <tbody> <tr> <td>**项目类型</td> <td>Project Type:**</td> </tr> <tr> <td>- 端到端AI功能</td> <td>end-to-end AI feature</td> </tr> <tr> <td>- 可扩展系统</td> <td>scalable system</td> </tr> <tr> <td>- 低延迟服务</td> <td>low-latency service</td> </tr> </tbody> </table> <table> <tbody> <tr> <td>**技术挑战</td> <td>Technical Challenge:**</td> </tr> <tr> <td>- Lambda冷启动</td> <td>Lambda cold starts</td> </tr> <tr> <td>- 高并发AI推理</td> <td>high-concurrency AI inference</td> </tr> <tr> <td>- 性能瓶颈</td> <td>performance bottleneck</td> </tr> </tbody> </table> <table> <tbody> <tr> <td>**解决方案</td> <td>Solution:**</td> </tr> <tr> <td>- 创新缓存策略</td> <td>innovative caching strategies</td> </tr> <tr> <td>- 负载均衡算法</td> <td>load balancing algorithms</td> </tr> <tr> <td>- 智能预热机制</td> <td>intelligent warm-up mechanisms</td> </tr> <tr> <td>- 请求路由优化</td> <td>request routing optimization</td> </tr> </tbody> </table> <p><strong>结果指标 | Results:</strong></p> <ul> <li> <table> <tbody> <tr> <td>API吞吐量</td> <td>API throughput</td> </tr> </tbody> </table> </li> <li> <table> <tbody> <tr> <td>3.1倍提升</td> <td>3.1x improvement</td> </tr> </tbody> </table> </li> <li> <table> <tbody> <tr> <td>响应时间</td> <td>response time</td> </tr> </tbody> </table> </li> <li>500ms→160ms</li> <li>QPS: 1000→3100</li> <li> <table> <tbody> <tr> <td>高可靠性</td> <td>high reliability</td> </tr> </tbody> </table> </li> </ul> <table> <tbody> <tr> <td>**业务影响</td> <td>Business Impact:**</td> </tr> <tr> <td>- 用户体验改善</td> <td>improved user experience</td> </tr> <tr> <td>- 直接影响</td> <td>direct impact</td> </tr> </tbody> </table> <p>30秒STAR回答： “在AWS实习期间，我构建了端到端AI功能，通过架构优化将API吞吐量提升3.1倍。我设计了创新的缓存策略和负载均衡算法，在保持高可靠性的同时大幅 提升性能，直接改善了用户体验。”</p> <p>Follow-up: What was the technical challenge? “主要是Lambda冷启动和高并发AI推理的延迟问题。我实现了智能预热机制和请求路由优化。”</p> <p>Follow-up: How did you measure the 3.1x improvement? “通过API响应时间监控和QPS指标，从原来的平均500ms降到160ms，并发处理能力从1000 QPS提升到3100 QPS。”</p> <p>30-second STAR response: “During my AWS internship, I built an end-to-end AI feature and improved API throughput by 3.1x through architectural optimization. I designed innovative caching strategies and load balancing algorithms that significantly boosted performance while maintaining high reliability, directly improving user experience.”</p> <p>Follow-up: What was the technical challenge? “The main issues were Lambda cold starts and latency in high-concurrency AI inference. I implemented intelligent warm-up mechanisms and request routing optimization.”</p> <p>Follow-up: How did you measure the 3.1x improvement? “Through API response time monitoring and QPS metrics - average response time dropped from 500ms to 160ms, and concurrent processing capacity increased from 1000 QPS to 3100 QPS.”</p> <h2 id="q3-tell-me-about-a-time-you-had-to-resolve-a-conflict">Q3: Tell me about a time you had to resolve a conflict</h2> <h3 id="逻辑框架--logic-framework-2">逻辑框架 | Logic Framework</h3> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>发现分歧 → 影响进度 → 组织讨论 → 数据验证 → 达成共识
Discover disagreement → Affect progress → Organize discussion → Data validation → Reach consensus
</code></pre></div></div> <h3 id="概念组合--concept-combinations-2">概念组合 | Concept Combinations</h3> <table> <tbody> <tr> <td>**冲突背景</td> <td>Conflict Background:**</td> </tr> <tr> <td>- 算法选择分歧</td> <td>algorithm selection disagreement</td> </tr> <tr> <td>- 项目进度影响</td> <td>project progress affected</td> </tr> <tr> <td>- 技术团队</td> <td>technical team</td> </tr> </tbody> </table> <table> <tbody> <tr> <td>**不同观点</td> <td>Different Viewpoints:**</td> </tr> <tr> <td>- 传统PID控制</td> <td>traditional PID control</td> </tr> <tr> <td>- 机器学习方法</td> <td>machine learning approaches</td> </tr> <tr> <td>- 稳定可靠</td> <td>stable and reliable</td> </tr> <tr> <td>- 处理复杂场景</td> <td>handle complex scenarios</td> </tr> </tbody> </table> <table> <tbody> <tr> <td>**解决方法</td> <td>Resolution Method:**</td> </tr> <tr> <td>- 技术评估会议</td> <td>technical evaluation meeting</td> </tr> <tr> <td>- A/B测试设计</td> <td>A/B test design</td> </tr> <tr> <td>- 实际飞行数据</td> <td>actual flight data</td> </tr> <tr> <td>- 数据说话</td> <td>let data speak</td> </tr> <tr> <td>- 客观对比</td> <td>objective comparison</td> </tr> </tbody> </table> <table> <tbody> <tr> <td>**结果证明</td> <td>Results:**</td> </tr> <tr> <td>- gradient-boosted模型</td> <td>gradient-boosted model</td> </tr> <tr> <td>- 精度高25%</td> <td>25% higher precision</td> </tr> <tr> <td>- 团队共识</td> <td>team consensus</td> </tr> <tr> <td>- 公平方式</td> <td>fairest approach</td> </tr> </tbody> </table> <p>30秒STAR回答： “在Purdue机器人团队中，技术团队对drone控制算法选择有分歧，影响项目进度。我组织了技术评估会议，设计A/B测试来比较不同方案。用数据证明 gradient-boosted模型比传统方法精度高25%，团队最终达成共识。”</p> <p>Follow-up: What were the different viewpoints? “一部分人倾向于传统PID控制，认为稳定可靠；另一部分人支持机器学习方法，认为能处理复杂场景。”</p> <p>Follow-up: How did you convince them to do A/B testing? “我提出用实际飞行数据做对比，让数据说话而不是主观判断。大家都认为这是最公平的方式。”</p> <p>30-second STAR response: “In the Purdue robotics team, there was disagreement about drone control algorithm selection that was affecting project progress. I organized a technical evaluation meeting and designed A/B tests to compare different approaches. Using data, I proved that the gradient -boosted model had 25% higher precision than traditional methods, and the team reached consensus.”</p> <p>Follow-up: What were the different viewpoints? “Some people favored traditional PID control, believing it was stable and reliable; others supported machine learning approaches, thinking they could handle complex scenarios.”</p> <p>Follow-up: How did you convince them to do A/B testing? “I proposed using actual flight data for comparison, letting data speak rather than subjective judgment. Everyone agreed this was the fairest approach.”</p> <h2 id="q4-tell-me-about-a-time-you-made-impact-outside-your-scope">Q4: Tell me about a time you made impact outside your scope</h2> <h3 id="逻辑框架--logic-framework-3">逻辑框架 | Logic Framework</h3> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>发现问题 → 影响团队 → 主动承担 → 深入优化 → 整体受益
Discover problem → Affect team → Take initiative → Deep optimization → Overall benefit
</code></pre></div></div> <h3 id="概念组合--concept-combinations-3">概念组合 | Concept Combinations</h3> <table> <tbody> <tr> <td>**问题识别</td> <td>Problem Identification:**</td> </tr> <tr> <td>- 物理引擎瓶颈</td> <td>physics engine bottleneck</td> </tr> <tr> <td>- 团队实验效率</td> <td>team experimental efficiency</td> </tr> <tr> <td>- 研究范围外</td> <td>outside research scope</td> </tr> </tbody> </table> <table> <tbody> <tr> <td>**影响观察</td> <td>Impact Observation:**</td> </tr> <tr> <td>- 团队成员等待</td> <td>team members waiting</td> </tr> <tr> <td>- 物理模拟慢</td> <td>slow physics simulations</td> </tr> <tr> <td>- 研究进度影响</td> <td>research progress affected</td> </tr> </tbody> </table> <table> <tbody> <tr> <td>**主动行动</td> <td>Proactive Action:**</td> </tr> <tr> <td>- 主动优化</td> <td>proactively optimized</td> </tr> <tr> <td>- 分析源码</td> <td>analyzed source code</td> </tr> <tr> <td>- 碰撞检测算法</td> <td>collision detection algorithm</td> </tr> <tr> <td>- 空间分割重构</td> <td>spatial partitioning refactor</td> </tr> </tbody> </table> <table> <tbody> <tr> <td>**技术细节</td> <td>Technical Details:**</td> </tr> <tr> <td>- Pymunk引擎</td> <td>Pymunk engine</td> </tr> <tr> <td>- 碰撞延迟</td> <td>collision latency</td> </tr> <tr> <td>- 碰撞检测逻辑</td> <td>collision detection logic</td> </tr> </tbody> </table> <table> <tbody> <tr> <td>**结果影响</td> <td>Results:**</td> </tr> <tr> <td>- 延迟降低70%</td> <td>70% latency reduction</td> </tr> <tr> <td>- 支持10+对象</td> <td>support 10+ objects</td> </tr> <tr> <td>- 团队整体效率</td> <td>overall team efficiency</td> </tr> <tr> <td>- 个人价值观</td> <td>personal values</td> </tr> </tbody> </table> <p>30秒STAR回答： “在AI Lab研究期间，我发现物理引擎性能瓶颈影响整个团队实验效率。虽然不在我研究范围内，我主动优化了Pymunk引擎，将碰撞延迟降低70%，支持10+ 对象处理，大幅提升了团队整体效率。”</p> <p>Follow-up: Why did you decide to work on this? “我看到团队成员经常因为物理模拟慢而等待，影响研究进度。我觉得解决这个问题比我个人研究更有价值。”</p> <p>Follow-up: How did you approach the optimization? “我分析了引擎源码，发现碰撞检测算法可以优化。重构了空间分割和碰撞检测逻辑。”</p> <p>30-second STAR response: “During my AI Lab research, I discovered that physics engine performance bottlenecks were affecting the entire team’s experimental efficiency. Although it wasn’t within my research scope, I proactively optimized the Pymunk engine, reducing collision latency by 70% and supporting 10+ object processing, significantly improving overall team efficiency.”</p> <p>Follow-up: Why did you decide to work on this? “I saw team members frequently waiting due to slow physics simulations, affecting research progress. I felt solving this problem was more valuable than my individual research.”</p> <p>Follow-up: How did you approach the optimization? “I analyzed the engine source code and found the collision detection algorithm could be optimized. I refactored the spatial partitioning and collision detection logic.”</p> <h2 id="q5-why-openai">Q5: Why OpenAI?</h2> <h3 id="逻辑框架--logic-framework-4">逻辑框架 | Logic Framework</h3> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>使命认同 → 经验匹配 → 价值观契合 → 贡献愿景 → 发展规划
Mission alignment → Experience match → Values alignment → Contribution vision → Development plan
</code></pre></div></div> <h3 id="概念组合--concept-combinations-4">概念组合 | Concept Combinations</h3> <table> <tbody> <tr> <td>**使命价值</td> <td>Mission Values:**</td> </tr> <tr> <td>- AGI造福全人类</td> <td>AGI benefits all humanity</td> </tr> <tr> <td>- 价值观契合</td> <td>values alignment</td> </tr> <tr> <td>- AI安全发展</td> <td>AI safety development</td> </tr> <tr> <td>- 广泛分布式收益</td> <td>broadly distributed benefits</td> </tr> </tbody> </table> <table> <tbody> <tr> <td>**个人背景</td> <td>Personal Background:**</td> </tr> <tr> <td>- AI研究经验</td> <td>AI research experience</td> </tr> <tr> <td>- 工程实践</td> <td>engineering practice</td> </tr> <tr> <td>- 技术前沿</td> <td>technical forefront</td> </tr> </tbody> </table> <table> <tbody> <tr> <td>**AI安全观点</td> <td>AI Safety Perspective:**</td> </tr> <tr> <td>- 至关重要</td> <td>crucial importance</td> </tr> <tr> <td>- 模型不可预测性</td> <td>model unpredictability</td> </tr> <tr> <td>- 技术发展平衡</td> <td>balance technological advancement</td> </tr> <tr> <td>- 安全保障</td> <td>safety assurance</td> </tr> <tr> <td>- 严格测试</td> <td>rigorous testing</td> </tr> <tr> <td>- 渐进部署</td> <td>gradual deployment</td> </tr> </tbody> </table> <table> <tbody> <tr> <td>**贡献规划</td> <td>Contribution Plan:**</td> </tr> <tr> <td>- 技术领导力</td> <td>technical leadership</td> </tr> <tr> <td>- 工程能力</td> <td>engineering capabilities</td> </tr> <tr> <td>- 快速发展平衡</td> <td>balance rapid development</td> </tr> <tr> <td>- 安全考量</td> <td>safety considerations</td> </tr> <tr> <td>- 团队协作</td> <td>team collaboration</td> </tr> <tr> <td>- AGI挑战</td> <td>AGI challenges</td> </tr> </tbody> </table> <p>30秒回答： “OpenAI的mission是确保AGI造福全人类，这与我的价值观高度契合。我在AI研究和工程实践中都有经验，希望在技术前沿的同时确保AI安全发展。我特别 认同OpenAI在AI safety和broadly distributed benefits方面的努力。”</p> <p>Follow-up: What do you think about AI safety? “AI safety至关重要。在研究中我看到AI模型的不可预测性。需要在技术发展和安全保障间平衡，通过严格测试和渐进部署确保可靠性。”</p> <p>Follow-up: How do you see yourself contributing in the first year? “我希望在technical leadership方面贡献工程能力，学习如何平衡快速发展和安全考量，参与团队协作解决AGI挑战。”</p> <p>30-second response: “OpenAI’s mission to ensure AGI benefits all of humanity aligns perfectly with my values. I have experience in both AI research and engineering practice, and I want to be at the technical forefront while ensuring AI develops safely. I particularly resonate with OpenAI’s efforts in AI safety and broadly distributed benefits.”</p> <p>Follow-up: What do you think about AI safety? “AI safety is crucial. In my research, I’ve seen the unpredictability of AI models. We need to balance technological advancement with safety assurance through rigorous testing and gradual deployment to ensure reliability.”</p> <p>Follow-up: How do you see yourself contributing in the first year? “I hope to contribute my engineering capabilities in technical leadership, learn how to balance rapid development with safety considerations, and participate in team collaboration to address AGI challenges.”</p> <h2 id="q6-tell-me-about-a-project-youre-proud-of">Q6: Tell me about a project you’re proud of</h2> <h3 id="逻辑框架--logic-framework-5">逻辑框架 | Logic Framework</h3> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>构建系统 → 性能挑战 → 创新优化 → 模型改进 → 综合提升
Build system → Performance challenge → Innovative optimization → Model improvement → Overall enhancement
</code></pre></div></div> <h3 id="概念组合--concept-combinations-5">概念组合 | Concept Combinations</h3> <table> <tbody> <tr> <td>**系统特点</td> <td>System Features:**</td> </tr> <tr> <td>- sketch-based控制</td> <td>sketch-based control</td> </tr> <tr> <td>- drone控制系统</td> <td>drone control system</td> </tr> <tr> <td>- 1K+并发用户</td> <td>1K+ concurrent users</td> </tr> </tbody> </table> <table> <tbody> <tr> <td>**性能优化</td> <td>Performance Optimization:**</td> </tr> <tr> <td>- React pipeline</td> <td>React pipeline</td> </tr> <tr> <td>- Web Workers</td> <td>Web Workers</td> </tr> <tr> <td>- 并行处理</td> <td>parallel processing</td> </tr> <tr> <td>- CPU使用率</td> <td>CPU usage</td> </tr> <tr> <td>- 62%降低</td> <td>62% reduction</td> </tr> <tr> <td>- 60 FPS维持</td> <td>maintain 60 FPS</td> </tr> <tr> <td>- 8K点sketches</td> <td>8K-point sketches</td> </tr> </tbody> </table> <table> <tbody> <tr> <td>**算法改进</td> <td>Algorithm Improvement:**</td> </tr> <tr> <td>- gradient-boosted ranking模型</td> <td>gradient-boosted ranking model</td> </tr> <tr> <td>- 命令精度</td> <td>command precision</td> </tr> <tr> <td>- 25%提升</td> <td>25% improvement</td> </tr> </tbody> </table> <table> <tbody> <tr> <td>**技术挑战</td> <td>Technical Challenge:**</td> </tr> <tr> <td>- 实时sketch处理</td> <td>real-time sketch processing</td> </tr> <tr> <td>- 性能问题</td> <td>performance issues</td> </tr> <tr> <td>- 主线程阻塞</td> <td>main thread blocking</td> </tr> </tbody> </table> <table> <tbody> <tr> <td>**验证方法</td> <td>Validation Method:**</td> </tr> <tr> <td>- flight test数据</td> <td>flight test data</td> </tr> <tr> <td>- 对比测量</td> <td>comparison measurement</td> </tr> <tr> <td>- drone执行准确度</td> <td>drone execution accuracy</td> </tr> <tr> <td>- 复杂路径</td> <td>complex paths</td> </tr> <tr> <td>- 明显更好表现</td> <td>significantly better performance</td> </tr> </tbody> </table> <p>30秒STAR回答： “我构建了一个sketch-based drone控制系统，服务1K+并发用户。通过Web Workers优化React pipeline，CPU使用率降低62%，维持60 FPS处理8K点 sketches。还开发了gradient-boosted ranking模型，命令精度提升25%。”</p> <p>Follow-up: What was the biggest technical challenge? “主要是实时sketch处理的性能问题。8K点的sketch会阻塞主线程，我用Web Workers做并行处理解决了这个问题。”</p> <p>Follow-up: How did you validate the 25% precision improvement? “通过flight test数据对比，测量drone执行sketch命令的准确度，新模型在复杂路径上表现明显更好。”</p> <p>30-second STAR response: “I built a sketch-based drone control system serving 1K+ concurrent users. I optimized the React pipeline using Web Workers, reducing CPU usage by 62% and maintaining 60 FPS for 8K-point sketches. I also developed a gradient-boosted ranking model that improved command precision by 25%.”</p> <p>Follow-up: What was the biggest technical challenge? “The main issue was real-time sketch processing performance. 8K-point sketches would block the main thread, so I used Web Workers for parallel processing to solve this problem.”</p> <p>Follow-up: How did you validate the 25% precision improvement? “Through flight test data comparison, measuring the accuracy of drone execution of sketch commands. The new model performed significantly better on complex paths.”</p> <h2 id="面试节奏提醒">面试节奏提醒：</h2> <p>• 每个问题准备被30秒内打断 • Follow-up要简洁，1-2句话 • 强调数据和结果 • 体现fast execution和leadership • 准备快速切换话题</p> </div> </article> <br> <hr> <br> <ul class="list-disc pl-8"></ul> <h2 class="text-3xl font-semibold mb-4 mt-12">Enjoy Reading This Article?</h2> <p class="mb-2">Here are some more articles you might like to read next:</p> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2025/Mock-Interview(3)/">Mock Interview(3), LeetCode</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2025/Backtracking/">Backtracking, LeetCode</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2025/Mock-Interview(2)/">Mock Interview(2), LeetCode</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2025/Tree/">Binary Tree, LeetCode</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2025/Nvidia/">NVIDIA, LeetCode</a> </li> </div> </div> <footer class="fixed-bottom" role="contentinfo"> <div class="container mt-0"> © Copyright 2025 Dong WANG. Powered by <a href="https://jekyllrb.com/" target="_blank" rel="external nofollow noopener">Jekyll</a> with <a href="https://github.com/alshedivat/al-folio" rel="external nofollow noopener" target="_blank">al-folio</a> theme. </div> </footer> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script src="/assets/js/bootstrap.bundle.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@5.0.0/imagesloaded.pkgd.min.js" integrity="sha256-htrLFfZJ6v5udOG+3kNLINIKh2gvoKqwEhHYfTTMICc=" crossorigin="anonymous"></script> <script defer src="/assets/js/masonry.js" type="text/javascript"></script> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.1.0/dist/medium-zoom.min.js" integrity="sha256-ZgMyDAIYDYGxbcpJcfUnYwNevG/xi9OHKaR/8GK+jWc=" crossorigin="anonymous"></script> <script defer src="/assets/js/zoom.js?85ddb88934d28b74e78031fd54cf8308"></script> <script src="/assets/js/no_defer.js?2781658a0a2b13ed609542042a859126"></script> <script defer src="/assets/js/common.js?e0514a05c5c95ac1a93a8dfd5249b92e"></script> <script defer src="/assets/js/copy_code.js?12775fdf7f95e901d7119054556e495f" type="text/javascript"></script> <script defer src="/assets/js/jupyter_new_tab.js?d9f17b6adc2311cbabd747f4538bb15f"></script> <script async src="https://d1bxh8uas1mnw7.cloudfront.net/assets/embed.js"></script> <script async src="https://badge.dimensions.ai/badge.js"></script> <script type="text/javascript">window.MathJax={tex:{tags:"ams"}};</script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/tex-mml-chtml.js" integrity="sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI=" crossorigin="anonymous"></script> <script defer src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6" crossorigin="anonymous"></script> <script type="text/javascript">function progressBarSetup(){"max"in document.createElement("progress")?(initializeProgressElement(),$(document).on("scroll",function(){progressBar.attr({value:getCurrentScrollPosition()})}),$(window).on("resize",initializeProgressElement)):(resizeProgressBar(),$(document).on("scroll",resizeProgressBar),$(window).on("resize",resizeProgressBar))}function getCurrentScrollPosition(){return $(window).scrollTop()}function initializeProgressElement(){let e=$("#navbar").outerHeight(!0);$("body").css({"padding-top":e}),$("progress-container").css({"padding-top":e}),progressBar.css({top:e}),progressBar.attr({max:getDistanceToScroll(),value:getCurrentScrollPosition()})}function getDistanceToScroll(){return $(document).height()-$(window).height()}function resizeProgressBar(){progressBar.css({width:getWidthPercentage()+"%"})}function getWidthPercentage(){return getCurrentScrollPosition()/getDistanceToScroll()*100}const progressBar=$("#progress");window.onload=function(){setTimeout(progressBarSetup,50)};</script> <script>var wechatModal=document.getElementById("WeChatMod"),wechatBtn=document.getElementById("WeChatBtn");wechatBtn.onclick=function(){wechatModal.style.display="block"},window.onclick=function(t){t.target==wechatModal&&(wechatModal.style.display="none")};</script> <script src="/assets/js/tabs.min.js?b8748955e1076bbe0dabcf28f2549fdc"></script> <script src="/assets/js/vanilla-back-to-top.min.js?f40d453793ff4f64e238e420181a1d17"></script> <script>addBackToTop();</script> <script type="module" src="/assets/js/search/ninja-keys.min.js?601a2d3465e2a52bec38b600518d5f70"></script> <ninja-keys hidebreadcrumbs noautoloadmdicons placeholder="Type to start searching"></ninja-keys> <script>let searchTheme=determineComputedTheme();const ninjaKeys=document.querySelector("ninja-keys");"dark"===searchTheme?ninjaKeys.classList.add("dark"):ninjaKeys.classList.remove("dark");const openSearchModal=()=>{const e=$("#navbarNav");e.hasClass("show")&&e.collapse("hide"),ninjaKeys.open()};</script> <script>const ninja=document.querySelector("ninja-keys");ninja.data=[{id:"nav-about",title:"About",section:"Navigation",handler:()=>{window.location.href="/"}},{id:"nav-blog",title:"Blog",description:"",section:"Navigation",handler:()=>{window.location.href="/blog/"}},{id:"nav-publications",title:"Publications",description:"publications by categories in reversed chronological order. generated by jekyll-scholar.",section:"Navigation",handler:()=>{window.location.href="/publications/"}},{id:"nav-projects",title:"Projects",description:"A growing collection of your cool projects.",section:"Navigation",handler:()=>{window.location.href="/projects/"}},{id:"post-mock-interview-3-leetcode",title:"Mock Interview(3), LeetCode",description:"LeetCode problems discussed during a mock interview on 2025-08-25",section:"Posts",handler:()=>{window.location.href="/blog/2025/Mock-Interview(3)/"}},{id:"post-backtracking-leetcode",title:"Backtracking, LeetCode",description:"LeetCode problems related to Backtracking",section:"Posts",handler:()=>{window.location.href="/blog/2025/Backtracking/"}},{id:"post-mock-interview-2-leetcode",title:"Mock Interview(2), LeetCode",description:"LeetCode problems discussed during a mock interview on 2025-07-18",section:"Posts",handler:()=>{window.location.href="/blog/2025/Mock-Interview(2)/"}},{id:"post-binary-tree-leetcode",title:"Binary Tree, LeetCode",description:"LeetCode problems related to Tree",section:"Posts",handler:()=>{window.location.href="/blog/2025/Tree/"}},{id:"post-nvidia-leetcode",title:"NVIDIA, LeetCode",description:"LeetCode problems frequently asked by NVIDIA",section:"Posts",handler:()=>{window.location.href="/blog/2025/Nvidia/"}},{id:"post-stack-and-queue-leetcode",title:"Stack and Queue, LeetCode",description:"LeetCode problems related to Stack and Queue",section:"Posts",handler:()=>{window.location.href="/blog/2025/Stack-and-Queue/"}},{id:"post-string-leetcode",title:"String, LeetCode",description:"LeetCode problems related to String",section:"Posts",handler:()=>{window.location.href="/blog/2025/String/"}},{id:"post-hashmap-leetcode",title:"HashMap, LeetCode",description:"LeetCode problems related to HashMap",section:"Posts",handler:()=>{window.location.href="/blog/2025/Hashmap/"}},{id:"post-mock-interview-1-leetcode",title:"Mock Interview(1), LeetCode",description:"LeetCode problems discussed during a mock interview on 2025-06-10",section:"Posts",handler:()=>{window.location.href="/blog/2025/Mock-Interview(1)/"}},{id:"post-meta-leetcode",title:"Meta, LeetCode",description:"LeetCode problems frequently asked by Meta",section:"Posts",handler:()=>{window.location.href="/blog/2025/Meta/"}},{id:"post-linked-list-leetcode",title:"Linked List, LeetCode",description:"LeetCode problems related to Linked List",section:"Posts",handler:()=>{window.location.href="/blog/2025/LinkedList/"}},{id:"post-array-leetcode",title:"Array, LeetCode",description:"LeetCode problems related to Array",section:"Posts",handler:()=>{window.location.href="/blog/2025/Array/"}},{id:"post-top-research-labs-in-machine-learning-systems-mlsys",title:"Top Research Labs in Machine Learning Systems (MLSys) \ud83d\udd2c",description:"A brief introduction to top-tier MLSys labs for Ph.D. applicants.",section:"Posts",handler:()=>{window.location.href="/blog/2024/mlsys-labs-intro/"}},{id:"post-reflection",title:"Reflection",description:"Reflection on Interview",section:"Posts",handler:()=>{window.location.href="/blog/2024/Reflection/"}},{id:"post-reflection",title:"Reflection",description:"Reflection on Interview",section:"Posts",handler:()=>{window.location.href="/blog/2024/OpenAI/"}},{id:"projects-2030",title:"2030",description:"Road to 2M by 2030",section:"Projects",handler:()=>{window.location.href="/projects/2030/"}},{id:"projects-project-2",title:"project 2",description:"a project with a background image and giscus comments",section:"Projects",handler:()=>{window.location.href="/projects/2_project/"}},{id:"projects-project-3-with-very-long-name",title:"project 3 with very long name",description:"a project that redirects to another website",section:"Projects",handler:()=>{window.location.href="/projects/3_project/"}},{id:"projects-project-4",title:"project 4",description:"another without an image",section:"Projects",handler:()=>{window.location.href="/projects/4_project/"}},{id:"projects-project-5",title:"project 5",description:"a project with a background image",section:"Projects",handler:()=>{window.location.href="/projects/5_project/"}},{id:"projects-project-6",title:"project 6",description:"a project with no image",section:"Projects",handler:()=>{window.location.href="/projects/6_project/"}},{id:"projects-project-7",title:"project 7",description:"with background image",section:"Projects",handler:()=>{window.location.href="/projects/7_project/"}},{id:"projects-project-8",title:"project 8",description:"an other project with a background image and giscus comments",section:"Projects",handler:()=>{window.location.href="/projects/8_project/"}},{id:"projects-project-9",title:"project 9",description:"another project with an image \ud83c\udf89",section:"Projects",handler:()=>{window.location.href="/projects/9_project/"}},{id:"projects-job-hunting",title:"Job Hunting",description:"Documenting my job search process",section:"Projects",handler:()=>{window.location.href="/projects/Job-Hunting/"}},{id:"socials-email",title:"Send email",section:"Socials",handler:()=>{window.open("mailto:%77%61%6E%67%64%6F%6E%67%30%35%30%32@%67%6D%61%69%6C.%63%6F%6D","_blank")}},{id:"socials-github",title:"GitHub",section:"Socials",handler:()=>{window.open("https://github.com/AABBCCDKG","_blank")}},{id:"socials-linkedin",title:"LinkedIn",section:"Socials",handler:()=>{window.open("https://www.linkedin.com/in/dong-bruce-wang-4463a62a8","_blank")}},{id:"socials-medium",title:"Medium",section:"Socials",handler:()=>{window.open("https://medium.com/@wangdong0502","_blank")}},{id:"socials-discord",title:"Discord",section:"Socials",handler:()=>{window.open("https://discord.com/users/1192920234429010000","_blank")}},{id:"light-theme",title:"Change theme to light",description:"Change the theme of the site to Light",section:"Theme",handler:()=>{setThemeSetting("light")}},{id:"dark-theme",title:"Change theme to dark",description:"Change the theme of the site to Dark",section:"Theme",handler:()=>{setThemeSetting("dark")}},{id:"system-theme",title:"Use system default theme",description:"Change the theme of the site to System Default",section:"Theme",handler:()=>{setThemeSetting("system")}}];</script> <script src="/assets/js/shortcut-key.js?6f508d74becd347268a7f822bca7309d"></script> </body> </html>